services:
  restaurant-service:
    build:
      context: ./services/restaurant-service
    image: mifos/restaurant-service:dev
    container_name: restaurant-service
    depends_on:
      restaurant-db:
        condition: service_healthy
    environment:
      PORT: 8082
      DATABASE_URL: postgresql://mifos:mifos@restaurant-db:5432/restaurant_service
    ports:
      - "8082:8082"
    networks:
      - app

  api-gateway:
    profiles: ["edge"]
    image: nginx:1.27-alpine
    container_name: api-gateway
    depends_on:
      - restaurant-service
    volumes:
      - ./deploy/gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    expose:
      - "80"
    networks:
      - app

  waf:
    profiles: ["edge"]
    build:
      context: ./deploy/waf
    image: mifos/waf:dev
    container_name: waf
    depends_on:
      - api-gateway
    ports:
      - "8080:80"
    networks:
      - edge
      - app

  order-service:
    build:
      context: ./services/order-service
    image: mifos/order-service:dev
    container_name: order-service
    depends_on:
      restaurant-service:
        condition: service_started
      order-db:
        condition: service_healthy
    environment:
      PORT: 8081
      RESTAURANT_SERVICE_URL: http://restaurant-service:8082
      PAYMENT_MODE: ${PAYMENT_MODE:-mock}
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_URL:-http://payment-service:8083}
      DATABASE_URL: postgresql://mifos:mifos@order-db:5432/order_service
    ports:
      - "8081:8081"
    networks:
      - app

  payment-service:
    profiles: ["payment"]
    build:
      context: ./services/payment-service
    image: mifos/payment-service:dev
    container_name: payment-service
    depends_on:
      payment-db:
        condition: service_healthy
    environment:
      PORT: 8083
      FAILURE_MODE: ${PAYMENT_FAILURE_MODE:-none}
      DATABASE_URL: postgresql://mifos:mifos@payment-db:5432/payment_service
    ports:
      - "8083:8083"
    networks:
      - app

  frontend:
    profiles: ["ui"]
    build:
      context: ./services/frontend
      args:
        VITE_ORDER_API: ${VITE_ORDER_API:-http://order-service:8081}
        VITE_RESTAURANT_API: ${VITE_RESTAURANT_API:-http://restaurant-service:8082}
    image: mifos/frontend:dev
    container_name: frontend
    depends_on:
      - restaurant-service
      - order-service
    ports:
      - "4173:80"
    networks:
      - app

  restaurant-db:
    image: postgres:16-alpine
    container_name: restaurant-db
    environment:
      POSTGRES_DB: restaurant_service
      POSTGRES_USER: mifos
      POSTGRES_PASSWORD: mifos
    volumes:
      - restaurant-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mifos -d restaurant_service"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - app

  order-db:
    image: postgres:16-alpine
    container_name: order-db
    environment:
      POSTGRES_DB: order_service
      POSTGRES_USER: mifos
      POSTGRES_PASSWORD: mifos
    volumes:
      - order-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mifos -d order_service"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - app

  payment-db:
    image: postgres:16-alpine
    container_name: payment-db
    environment:
      POSTGRES_DB: payment_service
      POSTGRES_USER: mifos
      POSTGRES_PASSWORD: mifos
    volumes:
      - payment-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mifos -d payment_service"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - app

networks:
  edge:
  app:

volumes:
  restaurant-db-data:
  order-db-data:
  payment-db-data:
