# This file is included at http{} context as /etc/nginx/conf.d/default.conf

# Enforce static API key from env at the gateway
# Rendered via envsubst from ${API_KEY}
map $http_x_api_key $is_auth {
    default 0;
    "${API_KEY}" 1;
}

upstream order_service { server order-service:8000; }
upstream restaurant_service { server restaurant-service:8001; }
upstream payment_service { server payment-service:8002; }

server {
    listen 8080;

    # Gateway health
    location = /healthz { return 200 'ok'; }

    location /api/orders/ {
        if ($is_auth = 0) { return 401; }
        proxy_set_header X-API-Key $http_x_api_key;
        proxy_pass http://order_service/;
    }

    location /api/restaurants/ {
        if ($is_auth = 0) { return 401; }
        proxy_set_header X-API-Key $http_x_api_key;
        proxy_pass http://restaurant_service/;
    }

    location /api/payments/ {
        if ($is_auth = 0) { return 401; }
        proxy_set_header X-API-Key $http_x_api_key;
        proxy_pass http://payment_service/;
    }
}
